@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    @using (Html.BeginForm())
    {
        <div class="form-group">
            <label for="emailContent">Email Content:</label>
            <textarea class="form-control" id="emailContent" rows="10">Dear Esteemed Speaker,

    Allow me to extend a most cordial welcome to CloudBrew and the fair country of Belgium. It is my sincere hope that your sojourn among us will prove not only pleasant but also intellectually and culturally enriching.

    We eagerly anticipate the privilege of your presence and look forward to the conversations and camaraderie that await.

    With all best wishes for your continued success and well-being, I remain,
    
    Yours faithfully and with the greatest repsect,


    </textarea>
        </div>
        <button type="button" id="rewriteButton" class="btn btn-primary mt-3">Rewrite</button>
        <div id="spinner" class="spinner-border text-primary" style="display: none;"></div>
        <div id="calculatedIndex"></div>
        <div id="result"></div>
        <button type="button" id="thumbsUpButton" class="btn btn-primary mt-3">Thumbs up!</button>
        <button type="button" id="thumbsDownButton" class="btn btn-primary mt-3">Thumbs down!</button>
    }
</div>

@section Scripts {
    <script>
        // Debounce function to delay the API call
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Function to call the API and update the result div
        async function callApiAndUpdateResult() {
            const emailContent = document.getElementById('emailContent').value;
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: emailContent })
                });
                const result = await response.json();
                document.getElementById('calculatedIndex').innerHTML = "<b>Readability index:</b>"+result.index;
            } catch (error) {
                console.error('Error calling API:', error);
            }
        }

        // Debounced version of the API call function
        const debouncedCallApi = debounce(callApiAndUpdateResult, 500);

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('emailContent').addEventListener('input', debouncedCallApi);
            
            //Calculate the readibility score immediately
            callApiAndUpdateResult();

            document.getElementById('thumbsUpButton').addEventListener('click', function () {
                const emailContent = {
                    content: document.getElementById('result').innerText
                };

                fetch('/api/score/thumbsup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailContent)
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            });
            
            document.getElementById('rewriteButton').addEventListener('click', function () {
                var emailContent = document.getElementById('emailContent').value;
                document.getElementById('rewriteButton').disabled = true;
                document.getElementById('spinner').style.display = 'block';
                fetch('/api/rewrite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 'content': emailContent })
                })
                .then(response => {
                    const reader = response.body.getReader();
                    const stream = new ReadableStream({
                        start(controller) {
                            function push() {
                                reader.read().then(({done, value}) => {
                                    if (done) {
                                        controller.close();
                                        document.getElementById('spinner').style.display = 'none';
                                        document.getElementById('rewriteButton').disabled = false;
                                        return;
                                    }
                                    controller.enqueue(value);
                                    document.getElementById('result').innerHTML += new TextDecoder().decode(value);
                                    push();
                                })
                            }
                            push();
                        }
                    });
                    return new Response(stream, { headers: { "Content-Type": "text/html" } });
                })
                .catch((error) => {
                    console.error('Error:', error);
                    document.getElementById('spinner').style.display = 'none';
                    document.getElementById('rewriteButton').disabled = false;
                });
            });
        });
    </script>
}
